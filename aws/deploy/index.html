<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="generator" content="mkdocs-1.6.1, mkdocs-terminal-4.6.0">
     
     
    
    <link rel="canonical" href="https://brunozalc.github.io/projeto-cloud/aws/deploy/"><link rel="icon" type="image/png" sizes="192x192" href="../../img/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="../../img/android-chrome-512x512.png" />
<link rel="apple-touch-icon" sizes="180x180" href="../../img/apple-touch-icon.png" />
<link rel="shortcut icon" type="image/png" sizes="48x48" href="../../img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="../../img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="../../img/favicon-32x32.png" />


    
 
<title>deploy usando kubernetes - Projeto Cloud 2024.2</title>


<link href="../../css/fontawesome/css/fontawesome.min.css" rel="stylesheet">
<link href="../../css/fontawesome/css/solid.min.css" rel="stylesheet">
<link href="../../css/normalize.css" rel="stylesheet">
<link href="../../css/terminal.css" rel="stylesheet">
<link href="../../css/theme.css" rel="stylesheet">
<link href="../../css/theme.tile_grid.css" rel="stylesheet">
<link href="../../css/theme.footer.css" rel="stylesheet">
<!-- dark color palette -->
<link href="../../css/palettes/dark.css" rel="stylesheet">

<!-- page layout -->
<style>
/* initially set page layout to a one column grid */
.terminal-mkdocs-main-grid {
    display: grid;
    grid-column-gap: 1.4em;
    grid-template-columns: auto;
    grid-template-rows: auto;
}

/*  
*   when side navigation is not hidden, use a two column grid.  
*   if the screen is too narrow, fall back to the initial one column grid layout.
*   in this case the main content will be placed under the navigation panel. 
*/
@media only screen and (min-width: 70em) {
    .terminal-mkdocs-main-grid {
        grid-template-columns: 4fr 9fr;
    }
}</style>



     
    
    

    
    <!-- search css support -->
<link href="../../css/search/bootstrap-modal.css" rel="stylesheet">
<!-- search scripts -->
<script>
    var base_url = "../..",
    shortcuts = "{}";
</script>
<script src="../../js/jquery/jquery-1.10.1.min.js" defer></script>
<script src="../../js/bootstrap/bootstrap.min.js" defer></script>
<script src="../../js/mkdocs/base.js" defer></script>
    
    
    
    
    <script src="../../search/main.js"></script>
    

    
</head>

<body class="terminal"><div class="container">
    <div class="terminal-nav">
        <header class="terminal-logo">
            <div id="mkdocs-terminal-site-name" class="logo terminal-prompt"><a href="https://brunozalc.github.io/projeto-cloud/" class="no-style">Projeto Cloud 2024.2</a></div>
        </header>
        
        <nav class="terminal-menu">
            
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../.." class="menu-item " property="item" typeof="WebPage">
                        <span property="name">home</span>
                    </a>
                    <meta property="position" content="0">
                </li>
                
                
                
                
                
                    
                    


<li property="itemListElement" typeof="ListItem">
    <a href="#" class="menu-item" data-toggle="modal" data-target="#mkdocs_search_modal" property="item" typeof="SearchAction">
        <i aria-hidden="true" class="fa fa-search"></i> <span property="name">Search</span>
    </a>
    <meta property="position" content="1">
</li>
                    
            </ul>
            
        </nav>
    </div>
</div>
        
    <div class="container">
        <div class="terminal-mkdocs-main-grid"><aside id="terminal-mkdocs-side-panel"><nav>
  
    <ul class="terminal-mkdocs-side-nav-items">
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../..">home</a>
        
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        
            
                
        

        
            
    
        
        
            
            
            <span class="
        
            
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">docker</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            
                
                
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../docker/uso/">download e uso</a>
        
    
    </li>
            
        
            
            
                
                
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../docker/api/">API</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        
            
                
        

        
            
    
        
        <span class="
        
            
        
    

    terminal-mkdocs-side-nav-item--active terminal-mkdocs-side-nav-section-no-index">aws</span>
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            
                
                
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        <span class="

    terminal-mkdocs-side-nav-item--active">deploy usando kubernetes</span>
    
    </li>
            
            
    </ul>
        
    
  </li>
        
    </ul>
  
</nav>
</aside>
            <main id="terminal-mkdocs-main-content">
    
    
    
    
    

<section id="mkdocs-terminal-content">
    <h1 id="hosteamento-da-api-na-aws-usando-eks">hosteamento da API na AWS usando EKS</h1>
<p>o deploy da API criada na primeira etapa foi feito através da AWS, utilizando-se o EKS (Elastic Kubernetes Service).</p>
<p>você pode acessar o site, hosteado na AWS, <a href="http://a48c61f312bcb4272b39806886348264-1612249103.us-east-1.elb.amazonaws.com/docs#/">aqui</a>.</p>
<h2 id="infraestrutura-utilizada">infraestrutura utilizada</h2>
<ul>
<li><strong>Amazon EKS</strong>: serviço gerenciado de Kubernetes</li>
<li><strong>EC2</strong>: instâncias para os nodes do cluster</li>
<li><strong>ELB</strong>: <em>load-balancer</em> para distribuição de tráfego</li>
<li><strong>IAM</strong>: gerenciamento de permissões do cluster</li>
</ul>
<h2 id="processo-de-implementacao">processo de implementação</h2>
<p>você pode baixar os arquivos <code>.yaml</code> de deploy <a href="https://download-directory.github.io/?url=https%3A%2F%2Fgithub.com%2Fbrunozalc%2Fprojeto-cloud%2Ftree%2Fmain%2Fk8s" target="_blank">aqui</a>.</p>
<h3 id="1-preparacao-do-ambiente">1. preparação do ambiente</h3>
<pre><code class="language-bash"># criação do cluster
eksctl create cluster \
      --name dogfacts \
      --region us-east-1 \
      --node-type t3.small \
      --nodes 2 \
      --nodes-min 1 \
      --nodes-max 3 \
      --managed
</code></pre>
<h3 id="2-deploy-da-aplicacao">2. deploy da aplicação</h3>
<p>a aplicação foi implantada usando o arquivo <code>api-deploy.yaml</code>:</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: projeto
spec:
  replicas: 1
  selector:
    matchLabels:
      app: projeto
  template:
    metadata:
      labels:
        app: projeto
    spec:
      containers:
        - name: projeto
          image: brunozalc/apicloud:latest
          ports:
            - containerPort: 8000
          # readiness test
          readinessProbe:
            httpGet:
              path: /
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 5
          # wait for database
          startupProbe:
            httpGet:
              path: /
              port: 8000
            failureThreshold: 30
            periodSeconds: 10
</code></pre>
<h3 id="3-configuracao-do-banco-de-dados">3. configuração do banco de dados</h3>
<p>o <code>postgres</code> também foi inicializado através de um arquivo <code>postgres-deploy.yaml</code>:</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres
          ports:
            - containerPort: 5432
          envFrom:
            - configMapRef:
                name: postgres-config
            - secretRef:
                name: postgres-secret
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - postgres
                - -d
                - dogfacts
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 5
</code></pre>
<h3 id="4-exposicao-do-servico">4. exposição do serviço</h3>
<p>o <code>postgres</code> foi exposto através de um serviço do tipo <code>ClusterIP</code>, na porta <code>5432</code></p>
<p>a API foi exposta através de um LoadBalancer:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: projeto
spec:
  type: LoadBalancer
  selector:
    app: projeto
  ports:
    - port: 8000
      targetPort: 8000
</code></pre>
<h2 id="comandos-posteriores">comandos posteriores</h2>
<pre><code class="language-bash"># checa que os pods estão em execução
kubectl get pods

# verifica os serviços (postgres e API)
kubectl get services

# logs do deployment da API
kubectl logs deployment/projeto
</code></pre>
<h2 id="medidas-de-seguranca">medidas de segurança</h2>
<ul>
<li>conta da AWS segura com MFA</li>
<li>cluster em VPC isolada</li>
<li><em>roles</em> do IAM com permissões necessárias</li>
<li><em>secrets</em> para credenciais do banco de dados</li>
<li><em>network policies</em> para isolamento de recursos</li>
</ul>
<h2 id="demonstracao">demonstração</h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/kp1-KOJTn48"
    title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
</iframe>
</section>

<section id="mkdocs-terminal-after-content">
    
</section>
<section id="mkdocs-terminal-revision">
<br>
<aside>
    <p>
        <small>
            <i>Page last updated 2024-11-17. See revision history on <a href="https://github.com/brunozalc/projeto-cloud/commits/main/docs/aws/deploy.md">GitHub</a>.</i>
        </small>
    </p>
</aside>
</section>
            </main>
        </div>
        <hr><footer>
    <div class="terminal-mkdocs-footer-grid">
        <div id="terminal-mkdocs-footer-copyright-info">
             Site built with <a href="http://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/ntno/mkdocs-terminal">Terminal for MkDocs</a>.
        </div>
        <div id="terminal-mkdocs-footer-prev-next">
            <nav class="btn-group">
                <a href="../../docker/api/" title="API">Previous</a>
                
            </nav>
        </div>
    </div>
</footer>
    </div>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="alertdialog" aria-modal="true" aria-labelledby="searchModalLabel">
    <div class="modal-dialog modal-lg" role="search">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close btn btn-default btn-ghost" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p id="searchInputLabel">Type to start searching</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" aria-labelledby="searchInputLabel" placeholder="" id="mkdocs-search-query" title="Please enter search terms here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No document matches found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    
</body>

</html>